---
title: Cholera in Yemen - mapping deaths from the current epidemic using HDX in R
author: ~
date: '2017-07-03'
slug: cholera-in-yemen
categories: []
tags: []
Categories: R
Description: ''
Tags: 
  - R
  - hdxr
  - sf
  - cholera
  - Yemen
  - gganimate
---

```{r start, message=FALSE, warning=FALSE, include=FALSE}
library(tidyverse)
library(hdxr)
library(ggplot2)
library(gganimate)
library(wesanderson)
library(sf)
library(stringr)
```

```{r data, message=FALSE, warning=FALSE, include=FALSE}
hdx_connect()
yemen_map <- hdx_dataset_search("yemen-admin-boundaries", exact = TRUE) %>%
  hdx_resource_list() %>%
  filter(name.resources == "Admin-1.zip") %>%
  hdx_resource_shapefile() %>%
  select(admin1Name, geometry)

yemen_data <- hdx_dataset_search("yemen-cholera-outbreak-daily-epidemiology-update", exact = TRUE) %>%
  hdx_resource_list() %>%
  hdx_resource_csv() %>%
  unnest() %>%
  rename(admin1Name = `COD Gov English`,
         cfr = `CFR (%)`,
         attack_rate = `Attack Rate (per 1000)`,
         deaths = Deaths,
         cases = Cases)

# HDX does not release info specifically for Hadramaut at the moment, but has released info for Mokla and Say'on,
# both parts of Hadramaut. This collects their info and uses it for Hadramaut as a whole

hadramaut <- yemen_data %>%
  filter(admin1Name == "#N/A") %>%
  group_by(Date) %>%
  summarise(admin1Name = "Hadramaut", cases = sum(cases), deaths = sum(deaths), cfr = sum(cfr)/2, attack_rate = sum(attack_rate)/2)

yemen_data <- bind_rows(yemen_data, hadramaut)

yemen_data$Date <- as.Date(yemen_data$Date)
```

```{r updated_data, message=FALSE, warning=FALSE, include=FALSE}
create_dates <- function(df, x){
  df %>%
    select_("Date", "admin1Name", x) %>%
    filter(!is.na(admin1Name)) %>%
    filter(admin1Name != "#N/A") %>%
    distinct() %>%
    spread_(key = "Date", value = x)%>%
    names() %>%
    stringr::str_subset(., "^2017")
  }
  
create_nas <- function(df, x){
  value_dates <- create_dates(df, x)
  
  df %>%
    select_("Date", "admin1Name", x) %>%
    filter(!is.na(admin1Name)) %>% 
    filter(admin1Name != "#N/A") %>%
    distinct() %>%
    spread_(key = "Date", value = x) %>%
    left_join(yemen_map, ., by = "admin1Name") %>%
    gather_("date", x, value_dates)
  }

deaths_data <- create_nas(yemen_data, "deaths")
deaths_data$date <- as.Date(deaths_data$date)

cases_data <- create_nas(yemen_data, "cases")
cases_data$date <- as.Date(cases_data$date)

cfr_data <- create_nas(yemen_data, "cfr")
cfr_data$date <- as.Date(cfr_data$date)

attack_data <- create_nas(yemen_data, "attack_rate")
attack_data$date <- as.Date (attack_data$date)

```

```{r joined_data_info, message=FALSE, warning=FALSE, include=FALSE}
attack_data <- attack_data %>% as_data_frame() %>% select(-geometry)
cases_data <- cases_data %>% as_data_frame() %>% select (-geometry)
cfr_data <- cfr_data %>% as_data_frame() %>% select(-geometry)


joined_data <- deaths_data %>%
  left_join(attack_data, by = c("admin1Name", "date")) %>%
  left_join(cases_data, by = c("admin1Name", "date")) %>%
  left_join(cfr_data, by = c("admin1Name", "date"))

#rm(attack_data, cases_data, cfr_data, deaths_data)
```

```{r yemen, message=FALSE, warning=FALSE, include=FALSE}
dates <- joined_data %>%
  ungroup() %>%
  as_data_frame() %>%
  select(date) %>%
  arrange(desc(date)) %>%
  unique() %>%
  mutate(previous_date = lead(date, n = 1)) %>%
  mutate(date_differences = as.numeric(date - previous_date))

previous_dates <- left_join(joined_data, dates, by = "date")

calculated_measures <- joined_data %>%
  as_data_frame() %>%
  select(admin1Name, date, previous_deaths = deaths, previous_cases = cases, previous_attack_rate = attack_rate)


joined_data <- left_join(previous_dates, calculated_measures, by = c("admin1Name", "previous_date" = "date")) %>%
  mutate(new_deaths_per_day = (deaths - previous_deaths)/date_differences,
         new_cases_per_day = (cases- previous_cases)/date_differences,
         new_attack_rate = (attack_rate - previous_attack_rate)/date_differences)

#rm(yemen_map, yemen_map_filtered, yemen_data, deaths_data, attack_data, cfr_data, cases_data, dates, deaths_data_names, calculated_measures, previous_dates)

dates <- joined_data %>%
  ungroup() %>%
  select(date) %>%
  arrange(desc(date))

most_recent <- dates[[1,1]]

today <- joined_data %>%
  filter(date == most_recent)
```

## Cholera in Yemen : UPDATED 12-JULY-2017

At the time of writing this, the WHO has released information about `r sum(today$cases, na.rm = TRUE)` cases of Cholera in Yemen, with `r sum(today$deaths, na.rm = TRUE)` deaths.

This information has been collated by the Humanitarian Data Exchange (HDX), and put [online](https://data.humdata.org/dataset/yemen-cholera-outbreak-daily-epidemiology-update). I made a new function for [hdxr](https://callumgwtaylor.github.io/hdxr/) the other day to make it easier to use maps from HDX, and wanted to learn more about what's happening in Yemen.

All the information below has been taken from HDX and read into R using hdxr. The code to run it all is in this [rmarkdown document](https://github.com/callumgwtaylor/blog/blob/master/content/post/2017-07-03-cholera-in-yemen.Rmd)


## Cholera Deaths

```{r deaths_maps, echo=FALSE, message=FALSE, warning=FALSE}
pal <- wes_palette("Zissou", 21, type = "continuous")
  
yemen_deaths_gif <- joined_data %>%
  ggplot() +
  geom_sf(aes(fill = deaths, frame = date)) +
  theme_bw() +
  scale_fill_gradientn(colours = pal) +
  labs(title = "Cholera Deaths in Yemen",
      subtitle = "Cumulative total of deaths in each administrative area",
      caption = "data from https://data.humdata.org/dataset/yemen-cholera-outbreak-daily-epidemiology-update")

gganimate(yemen_deaths_gif, "../../static/post/2017-07-03-cholera-in-yemen-mapping-deaths-from-the-current-epidemic_files/figure-html/yemen_deaths_gif.gif", ani.width=1000, ani.height=500)
```

![](/post/2017-07-03-cholera-in-yemen-mapping-deaths-from-the-current-epidemic_files/figure-html/yemen_deaths_gif.gif)



```{r deaths_line_graph, echo=FALSE, fig.height=6, fig.width=8, message=FALSE, warning=FALSE}
death_graph <- ggplot(joined_data) +
  geom_line(aes(x = date, y = deaths)) +
  facet_wrap(~admin1Name) +
  theme_minimal() + 
  theme(axis.text.x = element_text(angle=45, hjust = 1, vjust = 1)) +
  labs(x = "Date",
       y = "Deaths",
      title = "Cholera Deaths in Yemen",
      subtitle = "Cumulative total of deaths in each administrative area",
      caption = "data from https://data.humdata.org/dataset/yemen-cholera-outbreak-daily-epidemiology-update")


death_graph
```

## Cholera Cases

```{r cases_maps, echo=FALSE, message=FALSE, warning=FALSE}
pal <- wes_palette("Zissou", 21, type = "continuous")
  
yemen_cases_gif <- joined_data %>%
  ggplot() +
  geom_sf(aes(fill = cases, frame = date)) +
  theme_bw() +
  scale_fill_gradientn(colours = pal) +
  labs(title = "Cholera Cases in Yemen",
      subtitle = "Cumulative total of cases in each administrative area",
      caption = "data from https://data.humdata.org/dataset/yemen-cholera-outbreak-daily-epidemiology-update")

gganimate(yemen_cases_gif, "../../static/post/2017-07-03-cholera-in-yemen-mapping-deaths-from-the-current-epidemic_files/figure-html/yemen_cases_gif.gif", ani.width=1000, ani.height=500)
```

![](/post/2017-07-03-cholera-in-yemen-mapping-deaths-from-the-current-epidemic_files/figure-html/yemen_cases_gif.gif)

```{r cases_line, echo=FALSE, fig.height=6, fig.width=8, message=FALSE, warning=FALSE}
cases_graph <- ggplot(joined_data) +
  geom_line(aes(x = date, y = cases)) +
  facet_wrap(~admin1Name) +
  theme_minimal() +
  theme(axis.text.x = element_text(angle=45, hjust = 1, vjust = 1)) +
  labs(x = "Date",
       y = "Cases",
      title = "Cholera Cases in Yemen",
       subtitle = "Cumulative total of cases in each administrative area",
       caption = "data from https://data.humdata.org/dataset/yemen-cholera-outbreak-daily-epidemiology-update")

cases_graph
```

```{r facet_new_cases, echo=FALSE, message=FALSE, warning=FALSE, fig.height=8, fig.width=8}
wes <- wes_palette("Zissou", type = "continuous") %>%
  as.vector()


ggplot(joined_data, aes(x = date, y = new_cases_per_day)) +
  geom_point(alpha = 0.5) +
  geom_smooth(colour = wes[5]) +
  facet_wrap(~admin1Name) +
  theme_minimal() +
  theme(axis.text.x = element_text(angle=45, hjust = 1, vjust = 1)) +
  scale_y_continuous(limits = c(0, 1500)) +
  labs(x = "Date",
       y = "Cases",
      title = "Cholera Case Rates in Yemen",
      subtitle = "Calculated number of new cases of cholera per day in each area of Yemen",
      caption = "data from https://data.humdata.org/dataset/yemen-cholera-outbreak-daily-epidemiology-update")
```


```{r country_wide, echo=FALSE, message=FALSE, warning=FALSE}

countrywide <- joined_data %>%
  as_data_frame() %>%
  select(date, admin1Name, cases, deaths, new_cases_per_day, new_deaths_per_day) %>%
  group_by(date) %>%
  summarise(cases = sum(cases, na.rm = TRUE), deaths = sum(deaths, na.rm = TRUE), new_cases = sum(new_cases_per_day, na.rm = TRUE), new_deaths = sum(new_deaths_per_day, na.rm = TRUE))

ggplot(countrywide) +
  geom_line(aes(x = date, y = cases)) +
  theme_minimal() +
  theme(axis.text.x = element_text(angle=45, hjust = 1, vjust = 1)) +
  labs(x = "Date",
       y = "Cases",
      title = "Cholera Cases in Yemen",
       subtitle = "Cumulative total of cases countrywide",
       caption = "data from https://data.humdata.org/dataset/yemen-cholera-outbreak-daily-epidemiology-update")

ggplot(countrywide) +
  geom_line(aes(x = date, y = deaths)) +
  theme_minimal() +
  theme(axis.text.x = element_text(angle=45, hjust = 1, vjust = 1)) +
  labs(x = "Date",
       y = "Deaths",
      title = "Cholera Deaths in Yemen",
       subtitle = "Cumulative total of deaths countrywide",
       caption = "data from https://data.humdata.org/dataset/yemen-cholera-outbreak-daily-epidemiology-update")

ggplot(countrywide, aes(date, new_cases)) +
  geom_point(alpha = 0.5) +
  geom_smooth(colour = wes[5]) +
  theme_minimal() +
  theme(axis.text.x = element_text(angle=45, hjust = 1, vjust = 1)) +
  labs(x = "Date",
       y = "New Cases",
      title = "Cholera Case Rates in Yemen",
       subtitle = "Daily count of new cases of cholera countrywide",
       caption = "data from https://data.humdata.org/dataset/yemen-cholera-outbreak-daily-epidemiology-update")

ggplot(countrywide, aes(date, new_deaths)) +
  geom_point(alpha = 0.5) +
  geom_smooth(colour = wes[5]) +
  theme_minimal() +
  theme(axis.text.x = element_text(angle=45, hjust = 1, vjust = 1)) +
  labs(x = "Date",
       y = "New Deaths",
      title = "Cholera Death Rates in Yemen",
       subtitle = "Daily count of new deaths from cholera countrywide",
       caption = "data from https://data.humdata.org/dataset/yemen-cholera-outbreak-daily-epidemiology-update")
```


### Cholera Deaths Table

```{r deaths_table, echo=FALSE, message=FALSE, warning=FALSE}
 today %>%
   ungroup() %>%
   select(admin1Name, deaths, cases) %>%
   rename(`Administrative District` = admin1Name,
          Deaths = deaths,
          Cases = cases) %>%
   arrange(desc(Deaths)) %>%
   head() %>%
   knitr::kable(digits = 4)
```


### Cholera Cases Table

```{r cases_table, echo=FALSE, message=FALSE, warning=FALSE}
today %>%
  ungroup() %>%
  select(admin1Name, deaths, cases) %>%
  rename(`Administrative District` = admin1Name,
         Cases = cases,
         Deaths = deaths
         ) %>%
  arrange(desc(Cases)) %>%
  head() %>%
  knitr::kable()
```


