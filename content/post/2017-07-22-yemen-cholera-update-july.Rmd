---
title: In Yemen, cases of cholera and deaths continue to rise
author: ~
date: '2017-07-22'
slug: yemen-cholera-update-july
categories: []
tags: []
Categories: R
Description: ''
Tags: R
---

---
title: "R Notebook"
output: html_notebook
---


```{r start, message=FALSE, warning=FALSE, include=FALSE}
library(tidyverse)
library(hdxr)
library(ggplot2)
library(gganimate)
library(wesanderson)
library(sf)
library(stringr)
library(leaflet)
library(htmltools)
options(scipen = 999)
```

```{r data, message=FALSE, warning=FALSE, include=FALSE}
hdx_csv_workflow <- function(hdx){
  hdx_dataset_search(term = hdx, exact = TRUE) %>%
  hdx_resource_list() %>%
  hdx_resource_csv() %>%
  filter(dataset_identifier == "yemen-cholera-outbreak-daily-epidemiology-update_Yemen_Governorate_Level_Cholera_Epidemiology_Data") %>%
  unnest() %>%
  select(-dataset_identifier, -hdx_rel_url, -id)
}

hdx_connect()
yemen_map <- hdx_dataset_search("yemen-admin-boundaries", exact = TRUE) %>%
  hdx_resource_list() %>%
  filter(name.resources == "Admin-1.zip") %>%
  hdx_resource_shapefile() %>%
  select(admin1Name, geometry)

yemen_data <- hdx_csv_workflow("yemen-cholera-outbreak-daily-epidemiology-update") %>%
  rename(admin1Name = `COD Gov English`,
         cfr = `CFR (%)`,
         attack_rate = `Attack Rate (per 1000)`,
         deaths = Deaths,
         cases = Cases)

# HDX does not release info specifically for Hadramaut at the moment, but has released info for Mokla and Say'on,
# both parts of Hadramaut. This collects their info and uses it for Hadramaut as a whole

hadramaut <- yemen_data %>%
  filter(admin1Name == "#N/A") %>%
  group_by(Date) %>%
  summarise(admin1Name = "Hadramaut", cases = sum(cases), deaths = sum(deaths), cfr = sum(cfr)/2, attack_rate = sum(attack_rate)/2)

yemen_data <- bind_rows(yemen_data, hadramaut)

yemen_data$Date <- as.Date(yemen_data$Date)
```

```{r updated_data, message=FALSE, warning=FALSE, include=FALSE}
create_dates <- function(df, x){
  df %>%
    select_("Date", "admin1Name", x) %>%
    filter(!is.na(admin1Name)) %>%
    filter(admin1Name != "#N/A") %>%
    distinct() %>%
    spread_(key = "Date", value = x)%>%
    names() %>%
    stringr::str_subset(., "^2017")
  }
  
create_nas <- function(df, x){
  value_dates <- create_dates(df, x)
  
  df %>%
    select_("Date", "admin1Name", x) %>%
    filter(!is.na(admin1Name)) %>% 
    filter(admin1Name != "#N/A") %>%
    distinct() %>%
    spread_(key = "Date", value = x) %>%
    left_join(yemen_map, ., by = "admin1Name") %>%
    gather_("date", x, value_dates)
}

deaths_data <- create_nas(yemen_data, "deaths")
deaths_data$date <- as.Date(deaths_data$date)

cases_data <- create_nas(yemen_data, "cases")
cases_data$date <- as.Date(cases_data$date)

cfr_data <- create_nas(yemen_data, "cfr")
cfr_data$date <- as.Date(cfr_data$date)

attack_data <- create_nas(yemen_data, "attack_rate")
attack_data$date <- as.Date (attack_data$date)

```

```{r joined_data_info, message=FALSE, warning=FALSE, include=FALSE}
attack_data <- attack_data %>% as_data_frame() %>% select(-geometry)
cases_data <- cases_data %>% as_data_frame() %>% select (-geometry)
cfr_data <- cfr_data %>% as_data_frame() %>% select(-geometry)


joined_data <- deaths_data %>%
  left_join(attack_data, by = c("admin1Name", "date")) %>%
  left_join(cases_data, by = c("admin1Name", "date")) %>%
  left_join(cfr_data, by = c("admin1Name", "date"))

#rm(attack_data, cases_data, cfr_data, deaths_data)
```

```{r yemen, message=FALSE, warning=FALSE, include=FALSE}
dates <- joined_data %>%
  ungroup() %>%
  as_data_frame() %>%
  select(date) %>%
  arrange(desc(date)) %>%
  unique() %>%
  mutate(previous_date = lead(date, n = 1)) %>%
  mutate(date_differences = as.numeric(date - previous_date))

previous_dates <- left_join(joined_data, dates, by = "date")

calculated_measures <- joined_data %>%
  as_data_frame() %>%
  select(admin1Name, date, previous_deaths = deaths, previous_cases = cases, previous_attack_rate = attack_rate)


joined_data <- left_join(previous_dates, calculated_measures, by = c("admin1Name", "previous_date" = "date")) %>%
  mutate(new_deaths_per_day = (deaths - previous_deaths)/date_differences,
         new_cases_per_day = (cases- previous_cases)/date_differences,
         new_attack_rate = (attack_rate - previous_attack_rate)/date_differences)

#rm(yemen_map, yemen_map_filtered, yemen_data, deaths_data, attack_data, cfr_data, cases_data, dates, deaths_data_names, calculated_measures, previous_dates)

dates <- joined_data %>%
  ungroup() %>%
  select(date) %>%
  arrange(desc(date))

most_recent <- dates[[1,1]]

today <- joined_data %>%
  filter(date == most_recent)

today_map <- joined_data %>%
  filter(date == most_recent) %>%
  sf::st_as_sf()

countrywide <- joined_data %>%
  as_data_frame() %>%
  select(date, admin1Name, cases, deaths, new_cases_per_day, new_deaths_per_day) %>%
  group_by(date) %>%
  summarise(cases = sum(cases, na.rm = TRUE), deaths = sum(deaths, na.rm = TRUE), new_cases = sum(new_cases_per_day, na.rm = TRUE), new_deaths = sum(new_deaths_per_day, na.rm = TRUE))
```

## Cholera in Yemen : UPDATED 22-JULY-2017

**At the time of writing, the WHO has released information about `r sum(today$cases, na.rm = TRUE)` cases of cholera in Yemen, with `r sum(today$deaths, na.rm = TRUE)` deaths. This post uses data released on `r most_recent`. This information has been collated by the Humanitarian Data Exchange (HDX), and put [online](https://data.humdata.org/dataset/yemen-cholera-outbreak-daily-epidemiology-update). All the information below has been taken from HDX and read into R using [hdxr](https://callumgwtaylor.github.io/hdxr/). The code to run it all is in this [rmarkdown document](https://github.com/callumgwtaylor/blog/blob/master/content/post/2017-07-03-cholera-in-yemen.Rmd)**

Over the last fortnight the rate of new cases of cholera has slowed slightly, but we're still seeing more than 5000 new cases daily. Whilst numbers of new diagnoses of cholera are dropping in regions like Sana'a, more badly affected governates like Al Hudaydah show no signs of slowing down. The mortality rate is staying relatively static, with one in every 200 cases of cholera resulting in death.

According to [Oxfam](http://www.reuters.com/article/us-yemen-cholera-who-idUSKBN1A61GY), the total number of cases of cholera in Yemen could double with the rainy season to over 600,000. Keeping our current mortality rates, that's 3000 deaths from a preventable illness.

## Cholera Cases

### Total number of cases of cholera in each governate in Yemen
```{r leaflet_cases, echo=FALSE, message=FALSE, warning=FALSE}
wes <- wes_palette("Zissou", type = "continuous") %>%
  as.vector()

pal <- colorNumeric(
  palette = wes,
  domain = today_map$cases)

leaflet(today_map) %>%
  setView(lng = 47.985076, lat = 16.248058, zoom = 6) %>%
  addPolygons(stroke = FALSE, smoothFactor = 0.2, fillOpacity = 0.5,
    color = ~pal(cases), label = ~htmlEscape(str_c(admin1Name, ". Cases: ", cases))) %>%
  addLegend(pal = pal,values = ~cases, opacity = 0.5) %>%
  addTiles()
```

```{r cases_maps, echo=FALSE, message=FALSE, warning=FALSE}
pal <- wes_palette("Zissou", 21, type = "continuous")
  
yemen_cases_gif <- joined_data %>%
  ggplot() +
  geom_sf(aes(fill = cases, frame = date)) +
  theme_bw() +
  scale_fill_gradientn(colours = pal) +
  labs(title = "Cholera Cases in Yemen",
      subtitle = "Cumulative total of cases in each administrative area",
      caption = "https://callumgwtaylor.github.io/blog/ data from https://data.humdata.org/dataset/yemen-cholera-outbreak-daily-epidemiology-update")


gganimate(yemen_cases_gif, "../../static/post/2017-07-22-yemen-cholera-update-july_files/figure-html/yemen_cases_gif.gif", ani.width=1000, ani.height=500)
```

![](/post/2017-07-22-yemen-cholera-update-july_files/figure-html/yemen_cases_gif.gif)

```{r cases_line, echo=FALSE, fig.height=6, fig.width=8, message=FALSE, warning=FALSE}
cases_graph <- ggplot(joined_data) +
  geom_line(aes(x = date, y = cases)) +
  facet_wrap(~admin1Name) +
  theme_minimal() +
  theme(axis.text.x = element_text(angle=45, hjust = 1, vjust = 1)) +
  labs(x = "Date",
       y = "Cases",
      title = "Cholera Cases in Yemen",
       subtitle = "Cumulative total of cases in each administrative area",
       caption = "https://callumgwtaylor.github.io/blog/ data from https://data.humdata.org/dataset/yemen-cholera-outbreak-daily-epidemiology-update")

cases_graph
```

### Daily number of new cases of cholera in each governate in Yemen

```{r facet_new_cases, echo=FALSE, message=FALSE, warning=FALSE, fig.height=8, fig.width=8}
wes <- wes_palette("Zissou", type = "continuous") %>%
  as.vector()


ggplot(joined_data, aes(x = date, y = new_cases_per_day)) +
  geom_point(alpha = 0.5) +
  geom_smooth(colour = wes[5]) +
  facet_wrap(~admin1Name) +
  theme_minimal() +
  theme(axis.text.x = element_text(angle=45, hjust = 1, vjust = 1)) +
  scale_y_continuous(limits = c(0, 1500)) +
  labs(x = "Date",
       y = "Cases",
      title = "Cholera Case Rates in Yemen",
      subtitle = "Calculated number of new cases of cholera per day in each area of Yemen",
      caption = "https://callumgwtaylor.github.io/blog/ data from https://data.humdata.org/dataset/yemen-cholera-outbreak-daily-epidemiology-update")
```


## Cholera Deaths

### Total number of deaths from cholera in each governate in Yemen

```{r leaflet_deaths, echo=FALSE, message=FALSE, warning=FALSE}
wes <- wes_palette("Zissou", type = "continuous") %>%
  as.vector()

pal <- colorNumeric(
  palette = wes,
  domain = today_map$deaths)

leaflet(today_map) %>%
  setView(lng = 47.985076, lat = 16.248058, zoom = 6) %>%
  addPolygons(stroke = FALSE, smoothFactor = 0.2, fillOpacity = 0.5,
    color = ~pal(deaths), label = ~htmlEscape(str_c(admin1Name, ". Deaths: ", deaths))) %>%
  addLegend(pal = pal,values = ~deaths, opacity = 0.5) %>%
  addTiles()
```

```{r deaths_maps, echo=FALSE, message=FALSE, warning=FALSE}
pal <- wes_palette("Zissou", 21, type = "continuous")
  
yemen_deaths_gif <- joined_data %>%
  ggplot() +
  geom_sf(aes(fill = deaths, frame = date)) +
  theme_bw() +
  scale_fill_gradientn(colours = pal) +
  labs(title = "Cholera Deaths in Yemen",
      subtitle = "Cumulative total of deaths in each administrative area",
      caption = "https://callumgwtaylor.github.io/blog/ data from https://data.humdata.org/dataset/yemen-cholera-outbreak-daily-epidemiology-update")

gganimate(yemen_deaths_gif, "../../static/post/2017-07-22-yemen-cholera-update-july_files/figure-html/yemen_deaths_gif.gif", ani.width=1000, ani.height=500)
```

![](/post/2017-07-22-yemen-cholera-update-july_files/figure-html/yemen_deaths_gif.gif)




```{r deaths_line_graph, echo=FALSE, fig.height=6, fig.width=8, message=FALSE, warning=FALSE}
death_graph <- ggplot(joined_data) +
  geom_line(aes(x = date, y = deaths)) +
  facet_wrap(~admin1Name) +
  theme_minimal() + 
  theme(axis.text.x = element_text(angle=45, hjust = 1, vjust = 1)) +
  labs(x = "Date",
       y = "Deaths",
      title = "Cholera Deaths in Yemen",
      subtitle = "Cumulative total of deaths in each administrative area",
      caption = "https://callumgwtaylor.github.io/blog/ data from https://data.humdata.org/dataset/yemen-cholera-outbreak-daily-epidemiology-update")


death_graph
```


## Country Level

```{r country_wide, echo=FALSE, message=FALSE, warning=FALSE}
ggplot(countrywide) +
  geom_line(aes(x = date, y = cases)) +
  theme_minimal() +
  theme(axis.text.x = element_text(angle=45, hjust = 1, vjust = 1)) +
  scale_y_continuous(labels = scales::comma) +
  labs(x = "Date",
       y = "Cases",
      title = "Cholera Cases in Yemen",
       subtitle = "Cumulative total of cases countrywide",
       caption = "https://callumgwtaylor.github.io/blog/ data from https://data.humdata.org")

ggplot(countrywide) +
  geom_line(aes(x = date, y = deaths)) +
  theme_minimal() +
  theme(axis.text.x = element_text(angle=45, hjust = 1, vjust = 1)) +
  labs(x = "Date",
       y = "Deaths",
      title = "Cholera Deaths in Yemen",
       subtitle = "Cumulative total of deaths countrywide",
       caption = "https://callumgwtaylor.github.io/blog/ data from https://data.humdata.org/")

ggplot(countrywide, aes(date, new_cases)) +
  geom_point(alpha = 0.5) +
  geom_smooth(colour = wes[5]) +
  theme_minimal() +
  theme(axis.text.x = element_text(angle=45, hjust = 1, vjust = 1)) +
  scale_y_continuous(labels = scales::comma) +
  labs(x = "Date",
       y = "New Cases",
      title = "Cholera Case Rates in Yemen",
       subtitle = "Daily count of new cases of cholera countrywide",
       caption = "https://callumgwtaylor.github.io/blog/ data from https://data.humdata.org")

ggplot(countrywide, aes(date, new_deaths)) +
  geom_point(alpha = 0.5) +
  geom_smooth(colour = wes[5]) +
  theme_minimal() +
  theme(axis.text.x = element_text(angle=45, hjust = 1, vjust = 1)) +
  scale_y_continuous(labels = scales::comma) +
  labs(x = "Date",
       y = "New Deaths",
      title = "Cholera Death Rates in Yemen",
       subtitle = "Daily count of new deaths from cholera countrywide",
       caption = "https://callumgwtaylor.github.io/blog/ data from https://data.humdata.org/")
```


### Cholera Deaths Table

```{r deaths_table, echo=FALSE, message=FALSE, warning=FALSE}
 today %>%
   ungroup() %>%
   select(admin1Name, deaths, cases) %>%
   rename(`Administrative District` = admin1Name,
          Deaths = deaths,
          Cases = cases) %>%
   arrange(desc(Deaths)) %>%
   head() %>%
   knitr::kable(digits = 4)
```


### Cholera Cases Table

```{r cases_table, echo=FALSE, message=FALSE, warning=FALSE}
today %>%
  ungroup() %>%
  select(admin1Name, deaths, cases) %>%
  rename(`Administrative District` = admin1Name,
         Cases = cases,
         Deaths = deaths
         ) %>%
  arrange(desc(Cases)) %>%
  head() %>%
  knitr::kable()
```


