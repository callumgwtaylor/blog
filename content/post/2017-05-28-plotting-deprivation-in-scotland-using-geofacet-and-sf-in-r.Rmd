---
title: Plotting deprivation in Scotland, using geofacet and sf in R
author: ~
date: '2017-05-29'
slug: plotting-deprivation-in-scotland-using-geofacet-and-sf-in-r
categories: []
tags: []
Description: ''
Tags:
  - Deprivation
  - Public Health
  - R
  - Scotland
  - geofacet
  - sf
---

## Using the geofacet package to plot deprivation in Scotland by Health Boards

A few months ago, when I was first starting to learn to use R, I tried looking at the data from the [Scottish Index of Multiple Deprivation](http://www.gov.scot/Topics/Statistics/SIMD). The Scottish Government split Scotland up into 6976 equally populated "data zones" (not quite neighbourhoods, but pretty close), and ranked them from most deprived (1), to least deprived (6976)

Recently I've gone back to the same files, to see if what I've learnt has made it easier to look at deprivation in Scotland.

This weekend I found out about a new-ish package, geofacet from [Ryan Hafen](https://twitter.com/hafenstats). Luckily for me, [Joseph Adams](https://github.com/josephjosephadams) had already submitted a grid for Scottish Health Boards, making it so easy to plot this all out.

I've included the code I used to make the plot.

```{r library, echo=TRUE, message=FALSE, warning=FALSE}
library(tidyverse)
library(sf)
library(readxl)
library(geofacet)
```

```{r shape_file_import, echo=TRUE, message=FALSE, warning=FALSE}
map_scot <- st_read("../data/scot_gov_data/data_zone_shapefiles/.")
```

```{r excel_scot_gov_import, echo=TRUE, message=FALSE, warning=FALSE}
data_postcode_simd <- read_excel("../data/scot_gov_data/00505244.xlsx", sheet = 2)
data_simd_ranks <- read_excel("../data/scot_gov_data/00512735.xlsx", sheet = 3)

data_simd_ranks$HBname[data_simd_ranks$HBname == "Western Isles"] <- "Western Isle"
```

### Deprivation in Scotland by Health Boards

So looking at this, brighter colours equal lower average levels of deprivation. A distribution towards the left shows a healthboard with a greater proportion of deprived datazones.

Using the geofacet package, we swap out a normal `facet_wrap()` for `facet_geo()`, and tell it what layout we want `grid=("nhs_scot_grid")`. The only problem is that this grid has "Western Isles" saved as "Western Isle", so we have to rename out own data to match this. Now our health boards are placed in roughly a geographical order.

```{r geofacet_deprivation_plots, echo=TRUE, message=FALSE, warning=FALSE, fig.height=10, fig.width=7}
data_simd_ranks %>%
  select(DataZone = DZ, HBname) %>%
  left_join(map_scot, .) %>%
  group_by(HBname) %>%
  mutate(median_deprivation = median(Rank)) %>%
  ungroup() %>%
  ggplot() +
  geom_histogram(aes(x = Rank, y = ..ncount.., fill = median_deprivation), binwidth = 100) +
  facet_geo(~HBname, grid = "nhs_scot_grid") +
  labs(title = "Deprivation in Health Boards in Scotland",
       x = "Relative deprivation of data zones",
       y = "Proportion of data zones",
       caption = "Distribution to the left shows increased deprivation in healthboard, darker colour shows increased average deprivation of healthboard") + 
  theme_bw() +
  theme(legend.position = "none") 
```

### Glasgow versus Edinburgh

In the plot above, the west coast / east coast divide is looking pretty big in the central belt of Scotland. The plot below shows this even more. 
Glasgows neighbourhoods are massively skewed towards some of the most deprived parts of Scotland, whereas in Edinburgh we see the opposite. Obviously Glasgow still has some very well off parts, and Edinburgh has some deprived areas, but in this graph they seem to be polar opposites.

```{r central_belt__plots, echo=TRUE, message=FALSE, warning=FALSE, fig.height=4, fig.width=8}
city_data <- data_simd_ranks %>%
  select(DataZone = DZ, LAname) %>%
  left_join(map_scot, .) %>%
  group_by(LAname) %>%
  filter(LAname == "Glasgow City" | LAname == "City of Edinburgh") %>%
  mutate(median_deprivation = median(Rank)) %>%
  ungroup()

city_data$LAname <- parse_factor(city_data$LAname, levels = c("Glasgow City", "City of Edinburgh"))

  ggplot(city_data) +
  geom_histogram(aes(x = Rank, y = ..ncount.., fill = median_deprivation), binwidth = 100) +
  facet_wrap(~LAname) +
  labs(title = "Deprivation in Glasgow and Edinburgh",
       x = "Relative deprivation of data zones",
       y = "Proportion of data zones",
       caption = "Distribution to the left shows increased deprivation in city, darker colour shows increased average deprivation of city") + 
  theme_bw() +
  theme(legend.position = "none") 
```
